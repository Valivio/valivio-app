<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Valivio – Panel</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:20px}
  input,button{padding:8px;font-size:16px}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  table{border-collapse:collapse;width:100%;margin-top:20px}
  th,td{border:1px solid #ddd;padding:8px}
</style>

<h1>Panel – terminy</h1>

<section id="login">
  <div class="row">
    <input id="email" placeholder="email">
    <input id="pass" type="password" placeholder="hasło">
    <button id="btnLogin">Zaloguj</button>
    <span id="authMsg"></span>
  </div>
</section>

<section id="manage" style="display:none">
  <h2>Dodaj slot</h2>
  <div class="row">
    <input id="date" type="date">
    <select id="time" aria-label="Godzina (24h)"></select>
    <input id="dur" type="number" min="15" step="15" value="60">
    <button id="add">Dodaj</button>
  </div>

  <h2>Twoje sloty</h2>
  <table id="tbl"><thead><tr><th>ID</th><th>Data</th><th>Godzina</th><th>Akcje</th></tr></thead><tbody></tbody></table>
</section>

<script>
const API = (p,opt)=>fetch(p,Object.assign({credentials:'include'},opt||{}));
const $ = id => document.getElementById(id);

function buildTimeOptions(){
  const sel = $('time');
  if(!sel) return;
  sel.innerHTML = '';
  const start = 7*60;   // 07:00
  const end   = 21*60;  // 21:00
  const step  = 30;     // co 30 minut (zmień na 15 jeśli chcesz)
  for(let m=start; m<=end; m+=step){
    const h = Math.floor(m/60), min = m%60;
    const label = String(h).padStart(2,'0') + ':' + String(min).padStart(2,'0');
    const opt = document.createElement('option');
    opt.value = label; opt.textContent = label;
    sel.appendChild(opt);
  }
}

$('btnLogin').onclick = async ()=>{
  const res = await API('/api/login',{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ email: $('email').value.trim(), password: $('pass').value })
  });
  if(res.ok){ $('login').style.display='none'; $('manage').style.display='block'; loadSlots(); }
  else {$('authMsg').textContent='Błąd logowania';}
};

$('add').onclick = async ()=>{
  const date = $('date').value;
  const time = $('time').value;
  const duration = Number($('dur').value || 60);

  const r = await API('/api/slots', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ date, time, duration })
  });

  if (r.ok) { loadSlots(); return; }

  // pokaż dokładny błąd z API
  let msg = 'Nie udało się dodać';
  try {
    const body = await r.json();
    if (body && (body.message || body.error)) {
      msg += ` — ${body.message || body.error}`;
    }
  } catch {}
  alert(msg);
};

async function loadSlots(){
  const res = await API('/api/admin/slots'); const rows = await res.json();
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = rows.map(r=>{
    const d=new Date(r.startAt);
    const pl = new Intl.DateTimeFormat('pl-PL',{timeZone:'Europe/Warsaw',dateStyle:'medium',timeStyle:'short'}).format(d);
    const [date, time]=pl.split(', ');
    return `<tr><td>${r.id}</td><td>${date||''}</td><td>${time||''}</td>
      <td><button data-id="${r.id}" class="del">Usuń</button></td></tr>`;
  }).join('');
  tbody.onclick = async e=>{
    const btn=e.target.closest('.del'); if(!btn) return;
    if(!confirm('Usunąć termin?')) return;
    const r=await API('/api/slots/'+btn.getAttribute('data-id'),{method:'DELETE'});
    if(r.ok) loadSlots();
  };
}
</script>
