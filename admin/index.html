<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Valivio – Panel</title>
  <style>
    :root { color-scheme: light; }
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;margin:20px}
    h1{margin:0 0 16px}
    h2{margin:20px 0 8px;font-size:18px}
    input,select,button{padding:8px;font-size:16px}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center}
    .msg{margin-left:8px;font-size:14px;color:#555}
    table{border-collapse:collapse;width:100%;margin-top:20px}
    th,td{border:1px solid #ddd;padding:8px;text-align:left;vertical-align:top}
    .muted{color:#666}
    .danger{color:#9b1c1c}
    .ok{color:#0a7a33}
  </style>
</head>
<body>

  <h1>Panel – terminy</h1>

  <!-- Logowanie -->
  <section id="login">
    <h2>Zaloguj się</h2>
    <div class="row">
      <input id="email" type="email" placeholder="e-mail" autocomplete="username" />
      <input id="pass" type="password" placeholder="hasło" autocomplete="current-password" />
      <button id="btnLogin">Zaloguj</button>
      <span id="authMsg" class="msg"></span>
    </div>
  </section>

  <!-- Zarządzanie slotami -->
  <section id="manage" style="display:none">
    <h2>Dodaj slot</h2>
    <div class="row">
      <label for="date">Data:</label>
      <input id="date" type="date" />

      <label for="time">Godzina (24h):</label>
      <!-- Lista godzin w formacie 24h, generowana skryptem -->
      <select id="time" aria-label="Godzina (24h)"></select>

      <label for="dur">Czas (min):</label>
      <input id="dur" type="number" min="15" step="15" value="60" style="width:90px" />

      <button id="add">Dodaj</button>
      <span id="addMsg" class="msg"></span>
    </div>

    <h2>Twoje sloty</h2>
    <table id="tbl">
      <thead>
        <tr><th>ID</th><th>Data</th><th>Godzina</th><th>Akcje</th></tr>
      </thead>
      <tbody>
        <tr><td colspan="4" class="muted">Brak danych…</td></tr>
      </tbody>
    </table>
  </section>

  <script>
    // Proste utilsy
    const API = (p,opt)=>fetch(p,Object.assign({credentials:'include'},opt||{}));
    const $ = id => document.getElementById(id);

    // Generator listy godzin 24h (07:00–21:00 co 30 min)
    function buildTimeOptions(){
      const sel = $('time');
      if(!sel) return;
      sel.innerHTML = '';
      const START_MIN = 7*60;   // 07:00
      const END_MIN   = 21*60;  // 21:00
      const STEP      = 30;     // co 30 min (zmień na 15 jeśli chcesz)
      for(let m=START_MIN; m<=END_MIN; m+=STEP){
        const h = String(Math.floor(m/60)).padStart(2,'0');
        const min = String(m%60).padStart(2,'0');
        const label = `${h}:${min}`;
        const opt = document.createElement('option');
        opt.value = label; opt.textContent = label;
        sel.appendChild(opt);
      }
    }

    // Logowanie
    $('btnLogin').onclick = async ()=>{
      $('authMsg').textContent = '';
      const email = ($('email').value || '').trim();
      const password = $('pass').value || '';
      if(!email || !password){
        $('authMsg').textContent = 'Podaj e-mail i hasło.'; $('authMsg').className='msg danger';
        return;
      }
      const res = await API('/api/login',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ email, password })
      });
      if(res.ok){
        $('authMsg').textContent = 'Zalogowano.'; $('authMsg').className='msg ok';
        $('login').style.display='none';
        $('manage').style.display='block';
        buildTimeOptions();     // << lista 24h
        loadSlots();
      } else {
        $('authMsg').textContent='Błędny e-mail lub hasło.'; $('authMsg').className='msg danger';
      }
    };

    // Dodawanie slotu
    $('add').onclick = async ()=>{
      $('addMsg').textContent = '';
      const date = $('date').value;
      const time = $('time').value; // już w formacie 24h
      const duration = Number($('dur').value || 60);

      const r = await API('/api/slots', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ date, time, duration })
      });

      if (r.ok) {
        $('addMsg').textContent = 'Dodano.'; $('addMsg').className='msg ok';
        $('date').value=''; // opcjonalny reset
        loadSlots();
        return;
      }

      // pokaż szczegół błędu z backendu
      let msg = 'Nie udało się dodać';
      try {
        const body = await r.json();
        if (body && (body.message || body.error)) {
          msg += ` — ${body.message || body.error}`;
        }
      } catch {}
      $('addMsg').textContent = msg; $('addMsg').className='msg danger';
    };

    // Ładowanie / usuwanie slotów
    <script>
/* ... pozostale skrypty zostają bez zmian ... */

async function loadSlots(){
  const tbody = document.querySelector('#tbl tbody');
  try {
    const res = await fetch('/api/admin/slots?v=' + Date.now(), {
      credentials: 'include',
      headers: { 'Accept': 'application/json' },
      cache: 'no-store'
    });

    if (!res.ok) {
      const txt = await res.text().catch(()=> '');
      tbody.innerHTML = `<tr><td colspan="4" class="danger">
        Błąd pobierania (${res.status}). ${txt ? 'Szczegóły: '+txt.slice(0,200) : ''}
      </td></tr>`;
      return;
    }

    // upewnij się, że to JSON (a nie np. HTML przy 401)
    const ct = res.headers.get('content-type') || '';
    if (!ct.includes('application/json')) {
      const txt = await res.text().catch(()=> '');
      tbody.innerHTML = `<tr><td colspan="4" class="danger">
        Odpowiedź nie jest JSON (być może wygasła sesja). Odśwież stronę i zaloguj się ponownie.
        ${txt ? '<br><pre style="white-space:pre-wrap">'+txt.slice(0,200)+'</pre>' : ''}
      </td></tr>`;
      return;
    }

    const rows = await res.json();

    if (!Array.isArray(rows)) {
      tbody.innerHTML = `<tr><td colspan="4" class="danger">
        Nieoczekiwany format danych z API.
      </td></tr>`;
      return;
    }

    if (rows.length === 0) {
      tbody.innerHTML = `<tr><td colspan="4" class="muted">Brak slotów.</td></tr>`;
      return;
    }

    tbody.innerHTML = rows.map(r=>{
      const d = new Date(r.startAt);
      const pl = new Intl.DateTimeFormat('pl-PL',{
        timeZone:'Europe/Warsaw', dateStyle:'medium', timeStyle:'short'
      }).format(d);
      const parts = pl.split(', ');
      const date = parts[0] || '';
      const time = parts[1] || '';
      return `<tr>
        <td>${r.id}</td>
        <td>${date}</td>
        <td>${time}</td>
        <td><button data-id="${r.id}" class="del">Usuń</button></td>
      </tr>`;
    }).join('');

    tbody.onclick = async (e)=>{
      const btn = e.target.closest('.del'); if(!btn) return;
      if (!confirm('Usunąć ten termin?')) return;
      const id = btn.getAttribute('data-id');
      const r = await fetch('/api/slots/'+id, { method:'DELETE', credentials:'include' });
      if (r.ok) loadSlots();
      else alert('Nie udało się usunąć.');
    };

  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="4" class="danger">
      Wyjątek przy pobieraniu slotów: ${String(err).slice(0,200)}
    </td></tr>`;
  }
}
</script>
      const tbody = $('#tbl').querySelector('tbody');

      if (!res.ok) {
        tbody.innerHTML = `<tr><td colspan="4" class="danger">Nie udało się pobrać slotów.</td></tr>`;
        return;
      }

      const rows = await res.json();
      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="4" class="muted">Brak slotów.</td></tr>`;
        return;
      }

      tbody.innerHTML = rows.map(r=>{
        const d = new Date(r.startAt);
        // Format w strefie PL
        const pl = new Intl.DateTimeFormat('pl-PL',
          { timeZone:'Europe/Warsaw', dateStyle:'medium', timeStyle:'short' }
        ).format(d);
        const [date, time] = pl.split(', ');
        return `<tr>
          <td>${r.id}</td>
          <td>${date || ''}</td>
          <td>${time || ''}</td>
          <td><button data-id="${r.id}" class="del">Usuń</button></td>
        </tr>`;
      }).join('');

      tbody.onclick = async (e)=>{
        const btn = e.target.closest('.del'); if(!btn) return;
        if (!confirm('Usunąć ten termin?')) return;
        const id = btn.getAttribute('data-id');
        const r = await API('/api/slots/'+id, { method:'DELETE' });
        if (r.ok) loadSlots();
        else alert('Nie udało się usunąć.');
      };
    }
  </script>
</body>
</html>
