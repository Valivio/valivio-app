<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Valivio – Panel</title>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;margin:20px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    input,select,button{padding:8px;font-size:16px}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center}
    .msg{margin-left:8px;font-size:14px;color:#555}
    table{border-collapse:collapse;width:100%;margin-top:20px}
    th,td{border:1px solid #ddd;padding:8px;text-align:left;vertical-align:top}
    .muted{color:#666}
    .danger{color:#9b1c1c}
    .ok{color:#0a7a33}
    .status{font-weight:600}
    button[disabled]{opacity:.5;cursor:not-allowed}
  </style>
</head>
<body>

  <header>
    <h1>Panel – terminy</h1>
    <div>
      <span id="me" class="muted">—</span>
      <button id="logout">Wyloguj</button>
    </div>
  </header>

  <section>
    <h2>Dodaj slot</h2>
    <div class="row">
      <label for="date">Data:</label>
      <input id="date" type="date" />
      <label for="time">Godzina (24h):</label>
      <select id="time" aria-label="Godzina (24h)"></select>
      <label for="dur">Czas (min):</label>
      <input id="dur" type="number" min="15" step="15" value="60" style="width:90px" />
      <button id="add">Dodaj</button>
      <span id="addMsg" class="msg"></span>
    </div>

    <h2>Twoje sloty</h2>
    <table id="tbl">
      <thead>
        <tr><th>ID</th><th>Data</th><th>Godzina</th><th>Status</th><th>Akcje</th></tr>
      </thead>
      <tbody><tr><td colspan="5" class="muted">Ładowanie…</td></tr></tbody>
    </table>
  </section>

  <script>
    const API = (p,opt)=>fetch(p,Object.assign({credentials:'include'},opt||{}));
    const $ = id => document.getElementById(id);

    // Wymuś zalogowanie (jeśli token wygasł, wracamy do /admin – serwer poda login.html)
    async function guard(){
      const r = await API('/api/me', { headers:{'Accept':'application/json'}, cache:'no-store' });
      if(!r.ok){ location.href = '/admin'; return; }
      const me = await r.json(); $('me').textContent = me && me.email ? me.email : '';
    }

    function buildTimeOptions(){
      const sel = $('time'); sel.innerHTML='';
      const START_MIN = 7*60, END_MIN = 21*60, STEP = 30;
      for(let m=START_MIN; m<=END_MIN; m+=STEP){
        const h=String(Math.floor(m/60)).padStart(2,'0');
        const min=String(m%60).padStart(2,'0');
        const opt=document.createElement('option'); opt.value=`${h}:${min}`; opt.textContent=`${h}:${min}`;
        sel.appendChild(opt);
      }
    }

    $('logout').onclick = async ()=>{ await API('/api/logout',{method:'POST'}); location.href='/admin'; };

    $('add').onclick = async ()=>{
      $('addMsg').textContent='';
      const date=$('date').value, time=$('time').value, duration=Number($('dur').value||60);
      const r = await API('/api/slots',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({date,time,duration})});
      if(r.ok){ $('addMsg').textContent='Dodano.'; $('addMsg').className='msg ok'; $('date').value=''; loadSlots(); }
      else{
        let msg='Nie udało się dodać'; try{ const b=await r.json(); if(b.message||b.error) msg+=' — '+(b.message||b.error);}catch{}
        $('addMsg').textContent=msg; $('addMsg').className='msg danger';
      }
    };

    async function loadSlots(){
      const tbody = document.querySelector('#tbl tbody');
      try {
        const res = await API('/api/admin/slots?v='+Date.now(), { headers:{'Accept':'application/json'}, cache:'no-store' });
        if(!res.ok){ tbody.innerHTML = `<tr><td colspan="5" class="danger">Błąd pobierania (${res.status})</td></tr>`; return; }
        const rows = await res.json();
        if(!Array.isArray(rows)||rows.length===0){ tbody.innerHTML = `<tr><td colspan="5" class="muted">Brak slotów.</td></tr>`; return; }

        const df = new Intl.DateTimeFormat('pl-PL',{ timeZone:'Europe/Warsaw', dateStyle:'medium' });
        const tf = new Intl.DateTimeFormat('pl-PL',{ timeZone:'Europe/Warsaw', timeStyle:'short' });

        tbody.innerHTML = rows.map(r=>{
          const d = new Date(r.startAt);
          const dateStr = df.format(d);
          const timeStr = tf.format(d);
          const booked = Array.isArray(r.bookings) && r.bookings.length>0;
          const status = booked ? '<span class="status danger">zarezerwowany</span>' : '<span class="status ok">wolny</span>';
          const disabled = booked ? 'disabled' : '';
          return `<tr>
            <td>${r.id}</td>
            <td>${dateStr}</td>
            <td>${timeStr}</td>
            <td>${status}</td>
            <td><button data-id="${r.id}" class="del" ${disabled}>Usuń</button></td>
          </tr>`;
        }).join('');

        tbody.onclick = async (e)=>{
          const btn=e.target.closest('.del'); if(!btn) return;
          if(btn.hasAttribute('disabled')){ alert('Nie można usunąć: slot ma rezerwację.'); return; }
          if(!confirm('Usunąć ten termin?')) return;
          const id=btn.getAttribute('data-id');
          const r=await API('/api/slots/'+id,{method:'DELETE'});
          if(r.ok){ loadSlots(); }
          else{ try{ const b=await r.json(); alert((b.message||b.error)||'Nie udało się usunąć.'); }catch{ alert('Nie udało się usunąć.'); } }
        };

      } catch(err) {
        tbody.innerHTML = `<tr><td colspan="5" class="danger">Wyjątek: ${String(err).slice(0,200)}</td></tr>`;
      }
    }

    (async function start(){
      await guard();
      buildTimeOptions();
      loadSlots();
    })();
  </script>
</body>
</html>
